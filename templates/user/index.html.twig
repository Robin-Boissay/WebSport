{% extends 'base.html.twig' %}

{% block title %}Gestion des Amis{% endblock %}

{% block stylesheets %}
    {{ parent() }} {# Inclut les styles de base si nécessaire #}
    {# Lie le nouveau fichier CSS que nous allons créer #}
    <link rel="stylesheet" href="{{ asset('styles/user.css') }}">
{% endblock %}

{% block body %}
<div class="friends-management-container">

    <h1>Gestion des Amis</h1>

    {# Section : Demandes d'amis en attente #}
    <section class="friends-section pending-requests">
        <h2>Demandes d'amis reçues</h2>
        <ul class="user-list">
            {% set has_pending = false %}
            {% for request in friendReceived %}
                {% if request.status == 'pending' %}
                    {% set has_pending = true %}
                    <li class="user-item">
                        <span class="username">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M4 22a8 8 0 1 1 16 0h-2a6 6 0 0 0-12 0zm8-9c-3.315 0-6-2.685-6-6s2.685-6 6-6s6 2.685 6 6s-2.685 6-6 6m0-2c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4"/></svg>
                            {{ request.requester.username }}
                            </span>
                        <div class="user-actions">
                            {# Formulaire pour Accepter #}
                            
                            <form action="{{ path('app_accept_friend_request', {'id': request.id}) }}" method="POST" class="action-form">
                                <button type="submit" class="button button-success">Accepter</button>
                            </form>
                            {# Formulaire pour Refuser #}
                            <form action="{{ path('app_decline_friend_request', {'id': request.id}) }}" method="POST" class="action-form">
                                <button type="submit" class="button button-danger">Refuser</button>
                            </form>
                        </div>
                    </li>
                {% endif %}
            {% endfor %}

            {% if not has_pending %}
                <li class="no-items">Aucune demande d'ami en attente.</li>
            {% endif %}
        </ul>
    </section>

    {# Section : Mes Amis #}
    <section class="friends-section current-friends">
        <h2>Mes Amis</h2>
        <ul class="user-list">
            {% set has_friends = false %}
            {# Affichage des amis depuis les demandes envoyées et acceptées #}
            {% for relation in friendSent %}
                {% if relation.status == "accepted" %}
                    {% set has_friends = true %}
                    {% set friendUser = relation.receiver %}
                    <li class="user-item">
                        <span class="username">{{ friendUser.username }}</span>
                        <div class="user-actions">
                            <a href="{{ path('app_profile', {'id': friendUser.id}) }}" class="button button-secondary">Voir profil</a>
                            {# Optionnel : Bouton supprimer ami #}
                            {# <form action="{{ path('app_remove_friend', {'id': relation.id}) }}" method="POST" class="action-form">
                                <button type="submit" class="button button-danger">Retirer</button>
                            </form> #}
                        </div>
                    </li>
                {% endif %}
            {% endfor %}

            {# Affichage des amis depuis les demandes reçues et acceptées #}
            {% for relation in friendReceived %}
                 {# On vérifie seulement 'accepted' ici, car 'pending' est géré plus haut #}
                 {# Et on s'assure de ne pas lister à nouveau si friendSent l'a déjà fait (peu probable avec des données propres) #}
                {% if relation.status == "accepted" %}
                     {# Petite vérification pour éviter doublons si A->B et B->A existent ET sont acceptés #}
                     {% set is_already_listed = false %}
                     {% for sent_relation in friendSent %}
                        {% if sent_relation.status == "accepted" and sent_relation.receiver == relation.requester %}
                            {% set is_already_listed = true %}
                        {% endif %}
                     {% endfor %}

                     {% if not is_already_listed %}
                        {% set has_friends = true %}
                        {% set friendUser = relation.requester %}
                        <li class="user-item">
                            <span class="username">{{ friendUser.username }}</span>
                            <div class="user-actions">
                                <a href="{{ path('app_profile', {'id': friendUser.id}) }}" class="button button-secondary">Voir profil</a>
                                {# Optionnel : Bouton supprimer ami #}
                                {# <form action="{{ path('app_remove_friend', {'id': relation.id}) }}" method="POST" class="action-form">
                                    <button type="submit" class="button button-danger">Retirer</button>
                                </form> #}
                            </div>
                        </li>
                     {% endif %}
                {% endif %}
            {% endfor %}

            {% if not has_friends %}
                 <li class="no-items">Vous n'avez aucun ami pour le moment.</li>
            {% endif %}
        </ul>
    </section>

    {# Section : Tous les utilisateurs #}
    <section class="friends-section all-users">
        <h2>Trouver des utilisateurs</h2>
         <ul class="user-list">
            {% set has_other_users = false %}
            {% for user in users %}
                 {# Suppose que 'users' exclut déjà l'utilisateur courant (devrait être fait dans le contrôleur) #}
                 {% set has_other_users = true %}
                 <li class="user-item">
                    <span class="username">{{ user.username }}</span>
                    <div class="user-actions">
                         {# TODO : Conditionner l'affichage du bouton (ne pas montrer si déjà ami ou demande envoyée/reçue) #}
                         {# Cette logique est complexe en Twig, mieux vaut la faire dans le contrôleur #}
                        <form action="{{ path('app_user_send_friend_request', {'id': user.id}) }}" method="POST" class="action-form">
                            <button type="submit" class="button button-primary">Ajouter en ami</button>
                        </form>
                        <a href="{{ path('app_profile', {'id': user.id}) }}" class="button button-secondary">Voir profil</a>
                    </div>
                </li>
            {% endfor %}
             {% if not has_other_users %}
                 <li class="no-items">Aucun autre utilisateur trouvé.</li>
            {% endif %}
        </ul>
    </section>

</div>
{% endblock %}